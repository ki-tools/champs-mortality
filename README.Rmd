---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

<!-- devtools::build_readme() -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
options(width = 94)
```

# champsmortality

<!-- badges: start -->
[![R-CMD-check](https://github.com/ki-tools/champs-mortality/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/ki-tools/champs-mortality/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/ki-tools/champs-mortality/branch/main/graph/badge.svg)](https://app.codecov.io/gh/ki-tools/champs-mortality?branch=main)
<!-- badges: end -->

The goal of champsmortality is to provide functions for calculating mortality fractions and rates at CHAMPS sites for various causes.

## Installation

You can install the development version of champsmortality with the following:

``` r
install.packages("remotes") # one time only
remotes::install_github("ki-tools/champs-mortality")
```

## Example

```{r}
library(champsmortality)
```

### Data setup

The first time you use this package, you need to place the appropriate data files in a data directory that the package will pull from to perform the calculations. A function `create_dataset_directory()` is provided to help get this set up.

```{r strip.white=FALSE}
data_dir <- tempfile()
create_dataset_directory(data_dir)
```

This is something that only needs to be done once.

### Read the data

Once this is set up and the appropriate files are placed and mapped in the `config.yaml` file, you can read in the data with the following:

```{r}
input_path <- file.path(system.file(package = "champsmortality"), "testdata")

list.files(input_path)
```

TODO: Talk about the data in each of these files...

```{r}
d <- read_and_validate_data(input_path)
```

This will read in the data files and ensure that all of the variables required to perform the calculations are present. If they are not, you will see an error message and will need to correct the error before being able to use the package.

TODO: Talk about the structure of `d`.

### Process the data

A function, `process_data()` takes the data that has been read and joins it together to create an analysis dataset and DSS dataset ready for analysis.
```{r}
dd <- process_data(d, start_year = 2017, end_year = 2020)
```

### Valid conditions

Computations with this data typically have the goal of finding adjusted mortality fractions and rates for a given condition found in the causal chain. As you will see, these can be specified by either using the condition name or a [regular expression](https://www.sitepoint.com/learn-regex/) indicating ICD10 codes that indicate the condition.

A convenience function that lists all available conditions in the data is provided, `valid_conditions()`:

```{r}
valid_conditions(dd)
```

This searches the CHAMPS data and finds all unique condition values found anywhere in the causal chain. A ranking is also provided where a higher ranking indicates that the condition is found more frequently in the data than a condition with a lower ranking.

### Getting Rates and Fractions

```{r}
graf <- get_rates_and_fractions(
  dd,
  sites = c("S6", "S5", "S7"),
  catchments = c("C1", "C4", "C3", "C5", "C6", "C7"),
  causal_chain = FALSE,
  pval_cutoff = 0.1,
  pct_na_cutoff = 20,
  condition = "Lower respiratory infections")
```

TODO: Much more coming soon...
